<?php /* Template Name: FB Config */ ?><?phpsession_start();// added in v4.0.0require_once TEMPLATEPATH . '/facebooklogin/autoload.php';use Facebook\FacebookRedirectLoginHelper;use Facebook\FacebookRequest;use Facebook\FacebookRequestException;use Facebook\FacebookSession;use Facebook\GraphLocation;use Facebook\GraphUser;// init app with app id and secretFacebookSession::setDefaultApplication('1567989536863012', '7bfa46a00782b3624d38e0c91fc459dc');// login helper with redirect_uri$uri = get_bloginfo('url') . '/fbconfig/?fundraiser_id=' . $_GET['fundraiser_id'];if (isset($_GET['media']) && isset($_GET['uid'])) {    $uri .= '&media=' . $_GET['media'] . '&uid=' . $_GET['uid'];}if (isset($_GET['anonymous'])) {    $uri .= '&anonymous=' . $_GET['anonymous'];}if (isset($_GET['amount'])) {    $uri .= '&amount=' . $_GET['amount'];}$helper = new FacebookRedirectLoginHelper($uri);//$helper = new FacebookRedirectLoginHelper(get_bloginfo('url')."/fbconfig");try {    $session = $helper->getSessionFromRedirect();} catch (FacebookRequestException $ex) {    // When Facebook returns an error} catch (Exception $ex) {    // When validation fails or other local issues}// see if we have a sessionif (isset($session)) {    // graph api request for user data    $request = new FacebookRequest($session, 'GET', '/me?fields=name,email,first_name,last_name,location,hometown');    $response = $request->execute();    // get response    $graphObject = $response->getGraphObject();    $user = $response->getGraphObject(GraphUser::className());    $loc = $response->getGraphObject(GraphLocation::className());    $fbid = $graphObject->getProperty('id');              // To Get Facebook ID    $fbfullname = $graphObject->getProperty('name'); // To Get Facebook full name    $femail = $graphObject->getProperty('email');    // To Get Facebook email ID    $fbfirstname = $user->getFirstName();    $fblastname = $user->getLastName();    $fbcityname = $loc->getCity();    $fbstatename = $loc->getState();    $fbzipname = $loc->getZip();    $fbcountryname = $loc->getCountry();    //print_r($graphObject);    /* ---- Session Variables -----*/    //$_SESSION['FBID'] = $fbid;    //$_SESSION['FULLNAME'] = $fbfullname;    $_SESSION['EMAIL'] = $femail;    $_SESSION['FIRSTNAME'] = $fbfirstname;    $_SESSION['LASTNAME'] = $fblastname;    //$_SESSION['CITY'] = $fbcityname;    //$_SESSION['STATE'] = $fbstatename;    $_SESSION['ZIP'] = $fbzipname;    $_SESSION['COUNTRY'] = $fbcountryname;    /* ---- header location after session ----*/    $uri = get_bloginfo('url') . '/donation/?fundraiser_id=' . $_GET['fundraiser_id'];    if (isset($_GET['media']) && isset($_GET['uid'])) {        $uri .= '&media=' . $_GET['media'] . '&uid=' . $_GET['uid'];    }    if (isset($_GET['anonymous'])) {        $uri .= '&anonymous=' . $_GET['anonymous'];    }    if (isset($_GET['amount'])) {        $uri .= '&amount=' . $_GET['amount'];    }    header("Location: " . $uri);} else {    $loginUrl = $helper->getLoginUrl(array('scope' => 'email, public_profile, user_location, user_hometown'));    header("Location: " . $loginUrl);}?>